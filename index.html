<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>MovieHub - Phim Google Drive Proxy Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Xem phim tr√™n Google Drive si√™u m∆∞·ª£t, kh√¥ng gi·ªõi h·∫°n quota, giao di·ªán ƒë·∫πp, hi·ªáu ·ª©ng hi·ªán ƒë·∫°i, b·∫£o m·∫≠t tuy·ªát ƒë·ªëi.">
  <link rel="icon" type="image/png" href="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png"/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self' https://fonts.googleapis.com https://fonts.gstatic.com https://user-gen-media-assets.s3.amazonaws.com;
    frame-src https://drive.google.com;
    connect-src https://sheets.googleapis.com https://gdplayer.vip;
    img-src * data:;
    script-src 'self' 'unsafe-inline' https://cdn.plyr.io https://cdn.jsdelivr.net;
    style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.plyr.io;">
  <style>
    :root {
      --bg-main: #181818; --bg-modal: #23222c; --txt-main: #fff;
      --phim-card: #242333; --toolbar-title: #ffe066; --accent: #e50914; --accent2: #ffe066;
    }
    body { font-family:'Manrope',Arial,sans-serif;color:var(--txt-main);margin:0;background:linear-gradient(135deg,#23222e 60%,#222644 100%);}
    header{display:flex;align-items:center;gap:15px;padding:16px 8vw 14px 4vw;background:linear-gradient(93deg,#232335 83%,#301d34 101%);}
    .logo{height:40px;}
    .title{font-size:clamp(1.32em,3vw,2.20em);color:var(--accent);font-weight:800;margin-left:2px;letter-spacing:.01em;text-shadow:0 2px 14px #e5091451;}
    .right{margin-left:auto;display:flex;gap:15px;align-items:center;}
    .btn{padding:10px 21px;border:none;border-radius:9px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;transition:background .17s,box-shadow .18s,transform .09s;box-shadow:0 6px 26px #e5091422;}
    .btn:hover{background:#bb0917;}
    .btn:active{transform:scale(.96);}
    #genreFilter{padding:8px 13px;font-size:1em;border-radius:7px;background:#28223c;color:var(--accent2);border:none;}
    #themeToggle{margin-left:14px;padding:8px 16px;min-width:38px;}
    .container{max-width:1040px;margin:0 auto;padding:28px 7vw 70px 7vw;}
    h2{margin-top:38px;text-shadow:0 2px 11px #e509142a;font-size:clamp(1.30em,3vw,1.9em);font-weight:800;}
    .row-title{color:var(--accent2);font-size:1.16em;margin:38px 0 16px 9px;font-weight:800;text-shadow:0 3px 14px #e5091456;}
    .phimlist{display:flex;flex-wrap:wrap;gap:33px;}
    .phimcard{
      flex:0 0 216px;background:var(--phim-card);border-radius:22px;padding:0 0 14px 0;
      box-shadow:0 4px 33px #15153b18,0 1px 10px #ffe06612;overflow:hidden;position:relative;margin-bottom:14px;
      transition:transform .22s,border .13s,box-shadow .23s cubic-bezier(.18,1.1,.41,.97);opacity:0;cursor:pointer;}
    .phimcard.appear{animation:flyIn 0.57s cubic-bezier(.23,.74,.42,1.11) forwards;}
    .phimcard:hover{transform:scale(1.072) translateY(-11px);box-shadow:0 21px 51px #e5091421,0 1px 21px #ffe06621;border:2.5px solid #ffe06634;z-index:2;}
    .phimimg{width:100%;aspect-ratio:2/3;object-fit:cover;border-bottom:2px solid #262626;filter:brightness(.985);}
    .phimtitle{font-size:1.16em;margin:14px 16px 8px 15px;font-weight:900;}
    .phimmeta{font-size:1.08em;color:var(--accent2);padding:0 16px;}
    .badge-new{display:inline-block;background:var(--accent);color:#fff;padding:2px 13px;font-size:1em;border-radius:9px;margin:8px 0 0 14px;box-shadow:0 0 15px #ffe066cc,0 2px 11px #e5091440;}
    .badge-locked{background:#aabbc7;color:#173;padding:2px 12px;border-radius:11px;font-size:1em;position:absolute;top:11px;right:12px;}
    .watchbtn{margin:15px 0 0 17px;padding:9px 24px;font-size:1.11em;}
    .watchbtn.locked{background:#666;color:#ccc;}
    .modal{position:fixed;inset:0;background:#12162ede;backdrop-filter:blur(10px) brightness(.98);display:flex;align-items:center;justify-content:center;z-index:9999;}
    .modalDriveCustom{
      background:linear-gradient(135deg,var(--bg-modal) 90%,#19181d 120%);
      border-radius:26px;box-shadow:0 8px 62px #18172a84;
      padding:33px 27px 24px 27px;min-width:340px;width:99vw;max-width:820px;position:relative;max-height:97vh;
      display:flex;flex-direction:column;overflow-y:auto;animation:popModalIn .44s cubic-bezier(.32,1.31,.51,1) both;}
    .movie-player-plyr {display:none;}
    .movie-player-iframe {display:none;}
    .modalDriveCustom.show-plyr .movie-player-plyr {display:block;}
    .modalDriveCustom.show-drive .movie-player-iframe {display:block;}
    .plyr {border-radius:18px;box-shadow:0 8px 38px #1e1c2a7c;background:#161932;}
    @keyframes flyIn{0%{opacity:0;transform:translateY(46px) scale(.965);}100%{opacity:1;transform:translateY(0) scale(1);}}
    @keyframes popModalIn{0%{opacity:0;transform:scale(.80) translateY(70px);}70%{opacity:.84;transform:scale(1.01) translateY(-8px);}100%{opacity:1;transform:scale(1) translateY(0);}}
    .footer-moviehub{background:linear-gradient(129deg,#23212e 84%,#181930 106%);color:#ffe4b0;text-align:center;padding:25px 6vw 15px 6vw;font-size:1.08em;margin-top:50px;}
    .footer-logo{height:43px;width:auto;display:inline-block;vertical-align:middle;opacity:.98;}
    .footer-content{text-align:left;min-width:180px;line-height:1.57;}
    @media (max-width:650px){.footer-moviehub{padding:13px 2vw 17px 2vw;}.footer-logo{height:31px;}}
  </style>
</head>
<body>
<header>
  <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" class="logo" alt="MovieHub"/>
  <span class="title">MovieHub</span>
  <select id="genreFilter"><option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option></select>
  <button id="themeToggle" class="btn" onclick="toggleTheme()" aria-label="ƒê·ªïi giao di·ªán t·ªëi/s√°ng">üåô</button>
  <div class="right">
    <button id="loginBtn" class="loginhdr btn" style="display:inline-block">ƒêƒÉng nh·∫≠p</button>
    <button id="logoutBtn" class="logout" style="display:none">ƒêƒÉng xu·∫•t</button>
  </div>
</header>
<div class="container" role="main">
  <h2>Kho phim online - H·ªó tr·ª£ Google Drive, kh√¥ng gi·ªõi h·∫°n, giao di·ªán ƒëi·ªán ·∫£nh</h2>
  <div id="genreRows"></div>
</div>
<div id="playerModal" class="modal" style="display:none;" aria-modal="true" role="dialog">
  <div class="modalDriveCustom" onclick="event.stopPropagation();" tabindex="0">
    <button class="closebtn2" onclick="closePlayer()" aria-label="ƒê√≥ng player phim">&times;</button>
    <div class="movie-player-plyr">
      <video id="plyrVideo" playsinline controls poster="" style="width:100%;" crossorigin="anonymous"></video>
    </div>
    <div class="movie-player-iframe">
      <iframe id="driveFrame" style="width:100%;aspect-ratio:16/9;min-height:210px;border-radius:18px;background:#000;border:none;"></iframe>
    </div>
    <div class="player-toolbar">
      <span id="playerTitle" class="player-title">T√™n phim</span>
      <button class="btnshare" onclick="copyPlayerLink()" data-tip="D√°n ra b·∫•t k·ª≥ ƒë√¢u ƒë·ªÉ chia s·∫ª!">üìã Sao ch√©p link phim</button>
    </div>
    <div id="playerDesc" class="player-desc"></div>
  </div>
</div>
<footer class="footer-moviehub">
  <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" alt="MovieHub Logo" class="footer-logo"/>
  <div class="footer-content">
    <b style="font-size:1.13em;">MovieHub</b><br>
    ƒêƒÉng k√Ω t√†i kho·∫£n, h·ªó tr·ª£ v·∫•n ƒë·ªÅ li√™n quan...<br>
    Email: <a href="mailto:moviehub_vn@hotmail.com" style="color:#ffe066;text-decoration:underline;">moviehub_vn@hotmail.com</a>
  </div>
</footer>
<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ';
const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI';
const SHEET_RANGE = 'Sheet1!A1:Z';
let phimList = [], genresSet = new Set(), loggedUser = false;

function extractFileId(link) {
  let m = link.match(/file\/d\/([a-zA-Z0-9_-]+)/) || link.match(/[?&]id=([a-zA-Z0-9_-]+)/) || link.match(/^([a-zA-Z0-9_-]{25,})$/);
  return m ? m[1] : null;
}
async function getGdPlayerProxyMp4(fileId) {
  try{
    const api = `https://gdplayer.vip/api/video?file_id=${fileId}`;
    const res = await fetch(api);
    if(!res.ok) return null;
    const dt = await res.json();
    return dt.file;
  }catch(e){return null;}
}
async function showPhim(_id){
  let phim = phimList.find(m=>encodeURIComponent(m.id)===_id);
  if(!phim) return alert("Kh√¥ng t√¨m th·∫•y phim");
  if(phim.special&&!loggedUser) { alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem phim kho√°!'); return; }
  location.hash = "id=" + encodeURIComponent(phim.id);
  let fileId = extractFileId(phim.drive);
  let modal = document.querySelector('.modalDriveCustom');
  let poster = phim.poster||"";
  function fallbackDrivePreview() {
    document.getElementById('driveFrame').src = fileId?`https://drive.google.com/file/d/${fileId}/preview`:phim.drive;
    modal.classList.remove('show-plyr'); modal.classList.add('show-drive');
  }
  if(fileId){
    document.getElementById('playerTitle').innerText = phim.title;
    document.getElementById('playerDesc').innerText = phim.desc||"";
    document.querySelector(".movie-player-plyr").innerHTML = `<video id="plyrVideo" playsinline controls poster="${poster}" style="width:100%;" crossorigin="anonymous"></video>`;
    window.playerPlyr = new Plyr('#plyrVideo',{controls:['play-large','play','progress','current-time','duration','mute','volume','settings','fullscreen'],settings:['quality','speed','loop'],ratio:'16:9'});
    getGdPlayerProxyMp4(fileId).then(res=>{
      if(res){
        document.getElementById('plyrVideo').src = res;
        window.playerPlyr.source = {type:"video",sources:[{src:res,type:'video/mp4',size:720}]};
        modal.classList.remove('show-drive'); modal.classList.add('show-plyr');
      }else{
        fallbackDrivePreview();
      }
    }).catch(fallbackDrivePreview);
  }else{
    fallbackDrivePreview();
  }
  document.getElementById('playerModal').style.display = 'flex';
}
function closePlayer(){
  document.getElementById('driveFrame').src='';
  if(window.playerPlyr) window.playerPlyr.pause();
  document.getElementById('playerModal').style.display='none';
  document.querySelector('.modalDriveCustom').classList.remove('show-drive','show-plyr');
  history.replaceState(null, null, window.location.pathname);
}
function copyPlayerLink() {
  let link = window.location.origin + window.location.pathname + location.hash;
  navigator.clipboard.writeText(link);
  alert("ƒê√£ sao ch√©p link phim: " + link);
}
function toggleTheme() {
  const body = document.body;
  if(body.classList.contains("lightmode")){
    body.classList.remove("lightmode");
    document.getElementById('themeToggle').innerText = 'üåô';
    localStorage.setItem("moviehub_theme",'dark');
  } else {
    body.classList.add("lightmode");
    document.getElementById('themeToggle').innerText = '‚òÄÔ∏è';
    localStorage.setItem("moviehub_theme",'light');
  }
}
async function fetchPhim() {
  let url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`;
  let res = await fetch(url); let data = await res.json();
  let rows = data.values||[], header = rows[0];
  let idx = n => header.findIndex(x=>x&&x.trim().toLowerCase() === n);
  phimList = rows.slice(1).map(row=>(
    {title:row[idx('t√™n phim')]||'',desc:row[idx('m√¥ t·∫£')]||'',genre:row[idx('th·ªÉ lo·∫°i')]||'Kh√°c',drive:row[idx('link google drive')]||'',poster:row[idx('link poster')]||'',year:row[idx('nƒÉm')]||'',id:row[idx('id')]||row[idx('t√™n phim')]||'',special:(row[idx('special')]||'').trim().toLowerCase()==='yes',isNew:row[idx('nƒÉm')]&&+row[idx('nƒÉm')] >= (new Date().getFullYear()-1)})).filter(m=>m.title);
  genresSet = new Set(phimList.map(m=>m.genre).filter(g=>g&&g!==''));
  updateGenreOptions();renderPhim();
}
function updateGenreOptions() {
  let sel = document.getElementById("genreFilter");
  sel.innerHTML = `<option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option>
    ${Array.from(genresSet).map(g=>`<option value="${g}">${g}</option>`).join('')}`;
}
function renderPhim() {
  const sel = document.getElementById("genreFilter");
  let selected = sel.value || '';
  let phimTheoGenre = {};
  phimList.filter(m=>!selected||m.genre===selected)
    .forEach(m=>(phimTheoGenre[m.genre]=phimTheoGenre[m.genre]||[]).push(m));
  let html = '';
  for(const genre of Object.keys(phimTheoGenre)){
    html += `<div class="row-title">${genre}</div>
      <div class="phimlist">${
        phimTheoGenre[genre].map(m=>`<div class="phimcard" onclick="showPhim('${encodeURIComponent(m.id)}')">
        ${m.isNew?'<span class="badge-new">M·ªöI</span>':''}
        ${m.special?'<span class="badge-locked">Kho√°</span>':''}
        <img class="phimimg" src="${m.poster||'https://img.icons8.com/color/480/movie-projector.png'}" alt="">
        <div class="phimtitle">${m.title}</div>
        <div class="phimmeta">${m.genre||'Ch∆∞a r√µ'} | ${m.year||''}</div>
        <button class="btn watchbtn${m.special&&!loggedUser?' locked':''}" tabindex="-1" onclick="event.stopPropagation();showPhim('${encodeURIComponent(m.id)}')">
          ${m.special&&!loggedUser?'Ch·ªâ th√†nh vi√™n':'Xem phim'}
        </button>
      </div>`).join('')
      }</div>`;
  }
  document.getElementById('genreRows').innerHTML = html;
  setTimeout(()=>{document.querySelectorAll('.phimcard').forEach((el,i)=>setTimeout(()=>el.classList.add('appear'),80*i));},50);
}
window.onload = async ()=>{
  await fetchPhim();
  let th = localStorage.getItem("moviehub_theme");
  if(th==="light"){document.body.classList.add("lightmode");document.getElementById('themeToggle').innerText='‚òÄÔ∏è';}
  else{document.getElementById('themeToggle').innerText='üåô';}
  if (location.hash.startsWith("#id=")) {
    let id = decodeURIComponent(location.hash.slice(4));
    showPhim(encodeURIComponent(id));
  }
}
window.addEventListener("hashchange", ()=>{
  if (location.hash.startsWith("#id=")) {
    let id = decodeURIComponent(location.hash.slice(4));
    showPhim(encodeURIComponent(id));
  } else {
    closePlayer();
  }
});
document.getElementById("genreFilter").addEventListener("change", renderPhim);
</script>
</body>
</html>
