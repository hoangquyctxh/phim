<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>MovieHub ‚Äì T·ª± ƒë·ªông gom t·∫≠p phim t·ª´ Google Sheet</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=yes"/>
  <meta name="theme-color" content="#151324"/>
  <link rel="icon" type="image/svg+xml" href="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#151324;--card:#22223D;--acc:#e50914;--acc2:#ffe066;}
    body{background:var(--bg);margin:0;color:#fff;font-family:'Manrope',Arial,sans-serif;}
    header{display:flex;align-items:center;gap:22px;height:70px;padding:0 3vw 0 0;background:linear-gradient(87deg,#181843 88%,#af1e36 121%);}
    .logo{height:45px;width:45px;background:#fff;object-fit:cover;border-radius:16px;margin:0 17px;}
    .title{font-size:2em;font-weight:900;color:var(--acc);}
    .searchbox{padding:10px 19px;font-size:1.07em;border-radius:9px;border:none;outline:none;background:rgba(41,44,82,.88);color:#fff;margin-right:18px;min-width:200px;}
    #genreFilter{padding:10px 15px;border-radius:8px;background:#1f1c36dd;color:var(--acc2);font-size:1em;margin-right:17px;}
    .btn{padding:8px 23px;font-weight:900;border:none;border-radius:11px;background:var(--acc);color:#fff;}
    .container{max-width:1200px;margin:0 auto;padding:38px 4vw 88px 4vw;}
    .moviegrid{display:flex;flex-wrap:wrap;gap:36px;justify-content:flex-start;}
    @media (max-width:900px){.moviegrid{gap:16px;}}
    .phimcard{flex:0 1 265px;max-width:265px;background:var(--card);border-radius:21px;box-shadow:0 6px 24px #13142b7a;overflow:hidden;display:flex;flex-direction:column;position:relative;transition:.16s;cursor:pointer;}
    .phimcard:hover{transform:scale(1.045) translateY(-8px);box-shadow:0 17px 45px #e5091456,0 4px 22px #1e1e4680;}
    .phimimg{width:100%;aspect-ratio:2/3;object-fit:cover;display:block;}
    .badge-new{position:absolute;left:13px;top:13px;background:var(--acc);color:#fff;padding:2.5px 15px;border-radius:13px;font-weight:700;font-size:1.07em;}
    .badge-locked{background:var(--acc2);color:var(--acc);position:absolute;right:13px;top:15px;padding:2px 12.5px;border-radius:11px;font-weight:900;font-size:1.02em;}
    .phimtitle{margin:15px 15px 3px 17px;font-size:1.17em;font-weight:800;}
    .phimmeta{font-size:.98em;color:var(--acc2);margin:0 18px 7px;}
    .phimdesc{color:#fde9c8;margin:0 16px 8px;}
    .phimcast{color:#b6fddf;font-size:.98em;margin:0 0 7px 16px;}
    .watchbtn{margin:10px 0 17px 20px;padding:8px 21px;}
    .btn.watchbtn-ep-active{background: #ffe066 !important;color: #e50914 !important;font-weight: 900;border: 2px solid #ffe06644;transform: scale(1.13);}
    .modal{position:fixed;inset:0;background:rgba(16,13,29,.84);backdrop-filter:blur(9px);display:flex;align-items:center;justify-content:center;z-index:9000;}
    .modalDriveCustom{background:linear-gradient(144deg,#25223a 81%,#181834 131%);border-radius:28px;box-shadow:0 10px 53px #15142569;padding:29px 22px 19px 23px;max-width:540px;width:99vw;position:relative;}
    .closebtn2{position:absolute;right:13px;top:13px;background:var(--acc);color:#fff;border:none;border-radius:14px;padding:9px 16px;font-size:1.25em;}
    .movie-player-iframe{margin-bottom:14px;width:100%;}
    #playerFields{margin:19px 1px 0 7px;}
    #episodePicker{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;}
    .toast{position:fixed;right:24px;bottom:17px;z-index:39000;background:linear-gradient(90deg,#191b20 80%,#ffe066 102%);color:#e50914;padding:11px 21px 11px 13px;border-radius:9px;font-size:1.09em;box-shadow:0 2px 12px #3223;display:none;font-weight:800;}
    .footer-moviehub{background:#1a1a24;color:#ecdcbc;text-align:center;padding:14px 4vw 13px 4vw;margin-top:44px;font-size:1.07em;}
    .footer-logo{height:29px;opacity:.97;}
  </style>
</head>
<body>
<header>
  <img class="logo" src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" alt="MovieHub Logo"/>
  <span class="title">MovieHub</span>
  <input class="searchbox" id="quickSearch" placeholder="T√¨m phim/T√¨m di·ªÖn vi√™n..."/>
  <select id="genreFilter"><option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option></select>
  <button id="themeToggle" class="btn" onclick="toggleTheme()" aria-label="ƒê·ªïi theme">üåô</button>
</header>
<div class="container">
  <h2 style="font-size:1.35em;font-weight:900;padding:0 0 18px 0;">Danh s√°ch phim ‚Äì MovieHub t·ª± gom t·∫≠p phim t·ª´ Google Sheet, kh√¥ng c·∫ßn JSON</h2>
  <div id="genreRows" class="moviegrid"></div>
</div>
<div id="toastMsg" class="toast" aria-live="assertive"></div>
<div id="playerModal" class="modal" style="display:none;" aria-modal="true">
  <div class="modalDriveCustom">
    <button class="closebtn2" onclick="closePlayer()" aria-label="ƒê√≥ng player phim">&times;</button>
    <div class="movie-player-iframe"><iframe id="driveFrame" allowfullscreen allow="autoplay; fullscreen" style="width:100%;min-height:230px;border-radius:17px;background:#181818;border:none;"></iframe></div>
    <div class="player-toolbar"><span id="playerTitle" style="font-weight:900"></span>
      <button class="btn" onclick="copyPlayerLink()" style="margin-left:13px;">üìã Sao ch√©p link</button></div>
    <div id="playerFields"></div>
  </div>
</div>
<footer class="footer-moviehub">
  <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" alt="MovieHub Logo" class="footer-logo"/>
  <div class="footer-content">MovieHub &copy; 2025 ‚Äì T·ª± ƒë·ªông nh·∫≠n t·∫≠p phim t·ª´ Sheet, kh√¥ng c·∫ßn l·∫≠p tr√¨nh!</div>
</footer>
<script>
const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ';
const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI';
const SHEET_RANGE = 'Sheet1!A1:Z';

let phimFullList = [], phimList = [], genresSet = new Set();

function showToast(msg, dur = 2100){
  let t = document.getElementById('toastMsg');
  t.textContent = msg; t.style.display = "block";
  setTimeout(() => t.style.display = "none", dur);
}
function toggleTheme(){document.body.classList.toggle("lightmode");}

// CHU·∫®N HO√Å LINK
function normalizeDriveLink(lk){
  if(!lk) return "";
  return lk.replace(/\/view(\?.*)?$/,"/preview").replace(/\/edit(\?.*)?$/,"/preview").replace(/\s/g,"");
}

// ƒê·ªçc sheet: m·ªói d√≤ng 1 t·∫≠p - t·ª± ƒë·ªông gom th√†nh b·ªô phim!
async function fetchPhimFromSheet(){
  let url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`;
  let res = await fetch(url); let data = await res.json();
  let rows = data.values || [], header = rows[0];
  let col = n => { let i=header.findIndex(h=>h.trim().toLowerCase()==n); return i>=0?i:-1; };

  // CHUY·ªÇN V·ªÄ object danh s√°ch t·ª´ng d√≤ng-t·∫≠p
  let list = rows.slice(1).map(row=>{
    let obj = {};
    header.forEach((h,i)=>{
      let val = (row[i]||"").trim();
      if(h.toLowerCase().includes('link google drive')) val = normalizeDriveLink(val);
      obj[h.trim()] = val;
    });
    return obj;
  }).filter(m=>m["T√™n phim"]||m["ID"]);
  phimFullList = list;

  // GOM c√°c d√≤ng th√†nh b·ªô phim/t·∫≠p
  let phimGom = {};
  list.forEach(item=>{
    let id = item["ID"]||item["T√™n phim"];
    if(!phimGom[id]) phimGom[id] = {
      id:id, title: item["T√™n phim"], desc:item["M√¥ t·∫£"], genre:item["Th·ªÉ lo·∫°i"], year:item["NƒÉm"],
      poster:item["Link poster"], special:item["Special"], cast:item["Di·ªÖn vi√™n/ƒê·∫°o di·ªÖn"], comments:item["Comments"],
      rating:item["ƒêi·ªÉm trung b√¨nh"], trailer:item["Trailer"], episodes:[]
    };
    // G·ªôp m·ªói d√≤ng l√† 1 t·∫≠p phim
    let epNum = Number(item["T·∫≠p"]||1);
    phimGom[id].episodes.push({
      ep:epNum, title:item["M√¥ t·∫£"]||("T·∫≠p "+epNum), drive:item["Link Google Drive"], poster:item["Link poster"]||""
    });
    genresSet.add(item["Th·ªÉ lo·∫°i"]);
  });
  // B·ªè nh·ªØng phim ch·ªâ c√≥ link nh∆∞ng kh√¥ng h·ª£p l·ªá
  phimList = Object.values(phimGom).filter(m=>m.episodes.filter(e=>!!e.drive).length>0);
  renderPhim();
}

function renderPhim(){
  let html = '';
  phimList.forEach(m => {
    let isSeries = m.episodes.length>1;
    let poster = m.poster||m.episodes[0].poster||'https://img.icons8.com/color/480/movie-projector.png';
    html += `<div class="phimcard" onclick="showPhim('${m.id}',1)">
      <span class="badge-new" style="${m.year >= (new Date().getFullYear()-1)?'':'display:none'}">M·ªöI</span>
      ${m.special?'<span class="badge-locked">Kho√°</span>':''}
      <img class="phimimg" src="${poster}" alt="Phim: ${m.title}">
      <div class="phimtitle">${m.title}</div>
      <div class="phimmeta">${m.genre||'?'}, ${m.year||''}</div>
      <div class="phimdesc">${m.desc||''}</div>
      ${m.cast?`<div class="phimcast">Di·ªÖn vi√™n/ƒê·∫°o di·ªÖn: ${m.cast}</div>`:''}
      <button class="btn watchbtn" tabindex="-1" onclick="event.stopPropagation();showPhim('${m.id}',1)">${isSeries?"Ch·ªçn t·∫≠p":"Xem phim"}</button></div>`;
  });
  document.getElementById('genreRows').innerHTML = html;
}

function copyPlayerLink(){
  navigator.clipboard.writeText(window.location.origin+window.location.pathname+window.location.hash);
  showToast("ƒê√£ sao ch√©p link phim/t·∫≠p n√†y!");
}

function showPhim(_id, ep=1) {
  let m = phimList.find(x => String(x.id) === String(_id));
  if (!m) return showToast("Kh√¥ng t√¨m th·∫•y phim!");
  let epList = m.episodes || [];
  let epObj = epList.find(e=>String(e.ep)==String(ep)) || epList[0] || {};
  window.location.hash = epList.length>1 ? `id=${encodeURIComponent(m.id)}&ep=${epObj.ep||1}` : `id=${encodeURIComponent(m.id)}`;
  document.getElementById('playerTitle').innerText = epList.length>1 ? `${m.title} ‚Äì T·∫≠p ${epObj.ep}` : m.title;
  document.getElementById('playerFields').innerHTML = [
    `<div><b>M√¥ t·∫£:</b> ${m.desc||''}</div>`,
    `<div><b>NƒÉm:</b> ${m.year||''}</div>`,
    `<div><b>Th·ªÉ lo·∫°i:</b> ${m.genre||''}</div>`,
    m.cast ? `<div><b>Di·ªÖn vi√™n:</b> ${m.cast}</div>` : '',
    m.comments ? `<div><b>B√¨nh lu·∫≠n:</b> ${m.comments}</div>`:"",
    m.trailer ? `<div><b>Trailer:</b> <a href="${m.trailer}" target="_blank" style="color:#ffe066">Xem trailer</a></div>`:"",
    epList.length>1 ? `<div id="episodePicker">${
      epList.map(e=>`<button onclick="showPhim('${m.id}',${e.ep})" class="btn${e.ep==epObj.ep?' watchbtn-ep-active':''}">T·∫≠p ${e.ep}</button>`).join('')
    }</div>` : ''
  ].join('');
  let ifr = document.getElementById('driveFrame');
  if (epObj.drive && epObj.drive.includes("https://drive.google.com/")) {
    ifr.src = normalizeDriveLink(epObj.drive);
  } else {
    ifr.src = "";
    showToast("Kh√¥ng t√¨m th·∫•y link Google Drive h·ª£p l·ªá cho t·∫≠p phim n√†y!");
  }
  document.getElementById('playerModal').style.display = 'flex';
}
function closePlayer(){
  document.getElementById('driveFrame').src='';
  document.getElementById('playerModal').style.display='none';
  history.replaceState(null,null,window.location.pathname);
}
window.onload = () => {
  fetchPhimFromSheet();
  let params = new URLSearchParams(window.location.hash.replace('#',''));
  let showid = params.get('id'), epNum = +params.get('ep')||1;
  if(showid) showPhim(showid, epNum);
};
window.addEventListener("hashchange", () => {
  let params = new URLSearchParams(window.location.hash.replace('#',''));
  let showid = params.get('id'), epNum = +params.get('ep')||1;
  if(showid) showPhim(showid, epNum); else closePlayer();
});
</script>
</body>
</html>

