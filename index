<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>Phim Online Streaming (Google Drive)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { background: #181818; color: #fff; font-family: Arial,sans-serif; margin:0; }
    header { background:#222; padding:12px 24px; display:flex; flex-direction:row; align-items:center; gap:16px;}
    header h1 { margin:0; font-size:2em; color:#e50914;}
    #search { flex:1; padding:8px 16px; font-size:1em; border-radius:8px; border:none;}
    #genres { margin-left:24px;}
    #movie-list { display:flex; flex-wrap:wrap; gap:24px; padding:24px; justify-content:center;}
    .movie { width:200px; background:#232323; border-radius:12px; overflow:hidden; box-shadow:0 2px 6px #0005; cursor:pointer;}
    .movie img { width:100%; aspect-ratio:2/3; object-fit:cover;}
    .movie-info { padding:8px 12px;}
    .movie-title { font-size:1.15em; font-weight:bold; margin-bottom:2px;}
    .movie-genre, .movie-year, .movie-rating { font-size:0.95em; opacity:.8;}
    .movie-rating { color:#ffe27a;}
    .movie-desc { font-size:0.95em; margin-top:6px;}
    /* Modal Player */
    #modal-player { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.91); display:none; align-items:center; justify-content:center; z-index:10000;}
    #modal-content { background:#181818; border-radius:14px; padding:32px 24px; max-width:820px; width:96vw;}
    #player { text-align:center;margin-bottom:24px;}
    #close-btn { background:#e50914; color:#fff; border:none; border-radius:6px; padding:9px 14px; font-size:1em; cursor:pointer; float:right;}
    /* Comments and Rating Section */
    #movie-detail { color:#fff;}
    #detail-poster { float:left; width:160px; border-radius:10px; margin-right:18px; }
    #detail-title { font-size:1.35em; font-weight:bold; color:#ffe27a; margin-top:0;}
    #detail-desc { font-size:1em;}
    #rating-form { margin:14px 0;}
    #comments { margin-top:20px;}
    .comment { background:#262626; margin:8px 0; padding:10px 14px; border-radius:7px;}
    .comment-author { font-size:.92em; font-weight:bold;}
    .comment-text { margin-top:4px;}
    @media (max-width:600px) {
      #modal-content {padding:8px 0;max-width:100vw;}
      .movie{width:45vw;}
      #detail-poster{float:none;width:100%;margin:0;}
    }
  </style>
</head>
<body>
  <header>
    <h1>PHIM ONLINE</h1>
    <input type="search" id="search" placeholder="Tìm kiếm phim..."/>
    <select id="genres">
      <option value="">Tất cả thể loại</option>
    </select>
  </header>

  <main id="movie-list"></main>

  <!-- Modal player + detail -->
  <div id="modal-player">
    <div id="modal-content">
      <button id="close-btn" onclick="closePlayer()">Đóng</button>
      <div id="player"></div>
      <div id="movie-detail"></div>
      <div id="rating-form"></div>
      <div id="comments"></div>
      <div id="add-comment">
        <h4>Bình luận & đánh giá</h4>
        <form onsubmit="sendComment(event)">
          <input type="text" id="comment-author" placeholder="Tên của bạn" required style="width:32%;padding:8px;"/>
          <input type="number" id="comment-rating" min="1" max="5" placeholder="Điểm (1-5)" required style="width:16%;padding:8px;"/>
          <input type="text" id="comment-text" placeholder="Bình luận..." required style="width:36%;padding:8px;"/>
          <button type="submit" style="padding:7px 14px;">Gửi</button>
        </form>
      </div>
    </div>
  </div>

  <script>
  // CONFIG
  const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ'
  const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI'
  const SHEET_RANGE = 'Sheet1!A2:H' // Update range nếu bạn đổi sheet!
  const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbysq32epfb89btNoWGSxn-eEXMqeToCJQprpWkmNn_mIlyO9hfG1Kr8rHFjq47YX1eU/exec'

  let movieData = []
  let genres = new Set()
  let currentMovie = null
  let commentsCache = {}

  async function fetchMovies() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`
    const res = await fetch(url)
    const data = await res.json()
    movieData = (data.values||[]).map(row=>({
      title:row[0]||"",desc:row[1]||"",genre:row[2]||"",drive:row[3]||"",poster:row[4]||"",year:row[5]||"",rating:parseFloat(row[6]||'0'),id:row[7]||""
    }))
    genres = new Set(movieData.map(m=>m.genre))
  }

  function filterMovies(search="", genre="") {
    search = search.trim().toLowerCase()
    return movieData.filter(m=>{
      return (!genre||m.genre===genre) &&
        (
          !search ||
          m.title.toLowerCase().includes(search) ||
          m.desc.toLowerCase().includes(search)
        )
    })
  }

  function renderGenres() {
    const sel = document.getElementById("genres")
    sel.innerHTML = '<option value="">Tất cả thể loại</option>' +
      Array.from(genres).map(g=>`<option value="${g}">${g}</option>`).join('')
  }

  function renderMovies() {
    const search = document.getElementById("search").value
    const genre = document.getElementById("genres").value
    const filtered = filterMovies(search, genre)
    document.getElementById("movie-list").innerHTML = filtered.map(m=>`
      <div class="movie" onclick="openPlayer('${m.id}')">
        <img src="${m.poster||'https://img.icons8.com/color/480/movie-projector.png'}" alt="${m.title}"/>
        <div class="movie-info">
          <div class="movie-title">${m.title}</div>
          <div class="movie-genre">${m.genre||'Khác'} | <span class="movie-year">${m.year||''}</span></div>
          ${m.rating ? `<div class="movie-rating">★ ${m.rating.toFixed(1)}/5</div>`:""}
        </div>
      </div>
    `).join('')
  }

  function openPlayer(id) {
    currentMovie = movieData.find(m=>m.id===id)
    if(!currentMovie) return
    // Google Drive preview embed
    const fileId = currentMovie.drive.match(/[-\w]{25,}/)
    const embedUrl = fileId ? `https://drive.google.com/file/d/${fileId}/preview`:""
    document.getElementById("player").innerHTML = embedUrl ?
      `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" allowfullscreen style="border-radius:10px"></iframe>`:
      '<div>Không có video</div>'
    renderDetail(currentMovie)
    renderRatingForm(currentMovie)
    loadComments(currentMovie)
    document.getElementById("modal-player").style.display="flex"
  }

  function renderDetail(movie) {
    document.getElementById("movie-detail").innerHTML = `
      <img id="detail-poster" src="${movie.poster||''}" alt="${movie.title}"/>
      <h2 id="detail-title">${movie.title||''}</h2>
      <div class="movie-genre">Thể loại: <b>${movie.genre||'Không rõ'}</b></div>
      <div class="movie-year">Năm: ${movie.year||''}</div>
      <div class="movie-rating">★ ${movie.rating?movie.rating.toFixed(1):'Chưa có'}/5</div>
      <div class="movie-desc">${movie.desc||''}</div>
    `
  }

  function renderRatingForm(movie) {
    document.getElementById("rating-form").innerHTML = `
      <form onsubmit="sendRating(event)">
        <label>Chấm điểm phim: </label>
        <select id="input-rating" required>
          <option value="">Chọn...</option>
          <option value="1">1 điểm</option>
          <option value="2">2 điểm</option>
          <option value="3">3 điểm</option>
          <option value="4">4 điểm</option>
          <option value="5">5 điểm</option>
        </select>
        <button type="submit">Gửi</button>
      </form>
    `
  }

  async function sendRating(event) {
    event.preventDefault()
    const rating = document.getElementById("input-rating").value
    if (!rating || !currentMovie.id) return
    // Gửi rating tới Apps Script
    await fetch(SCRIPT_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({type:"rating",id:currentMovie.id,rating}),
      headers:{ "Content-Type":"application/json" }
    })
    alert("Chấm điểm thành công!")
    closePlayer(); await refreshData(); // Reload data (update rating)
  }

  async function loadComments(movie) {
    // Lấy comment qua Apps Script
    const res = await fetch(`${SCRIPT_ENDPOINT}?type=comments&id=${movie.id}`)
    const data = await res.json()
    const comments = data.comments || []
    commentsCache[movie.id] = comments
    document.getElementById("comments").innerHTML = "<h4>Bình luận:</h4>" +
      (comments.length?
      comments.map(c=>`
        <div class="comment">
          <div class="comment-author">${c.author||'Ẩn danh'} ${c.rating?`★ ${c.rating}/5`:""}</div>
          <div class="comment-text">${c.text}</div>
        </div>
      `).join(''): '<i>Chưa có bình luận nào.</i>')
  }

  async function sendComment(event) {
    event.preventDefault()
    if(!currentMovie) return
    const author = document.getElementById("comment-author").value
    const text = document.getElementById("comment-text").value
    const rating = document.getElementById("comment-rating").value
    if(!author||!text||!rating) return
    await fetch(SCRIPT_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({type:"comment",id:currentMovie.id,author,text,rating}),
      headers:{"Content-Type":"application/json"}
    })
    alert("Bình luận đã gửi!")
    document.getElementById("comment-author").value=""
    document.getElementById("comment-text").value=""
    document.getElementById("comment-rating").value=""
    await loadComments(currentMovie)
  }

  function closePlayer() {
    document.getElementById("modal-player").style.display = "none"
    document.getElementById("player").innerHTML=""
    document.getElementById("movie-detail").innerHTML=""
    document.getElementById("comments").innerHTML=""
    document.getElementById("rating-form").innerHTML=""
    currentMovie=null
  }

  async function refreshData() {
    await fetchMovies()
    renderGenres()
    renderMovies()
  }

  document.getElementById("search").addEventListener("input", renderMovies)
  document.getElementById("genres").addEventListener("change", renderMovies)
  window.onload = refreshData
  </script>
</body>
</html>
