<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>MovieHub ‚Äì Xem phim, kho√° t·∫≠p, Vi·ªát ho√° ƒë·∫πp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css"/>
  <meta name="theme-color" content="#151324"/>
  <link rel="icon" type="image/svg+xml" href="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png">
  <style>
    body{font-family:'Be Vietnam Pro',sans-serif;background:#181843;margin:0;color:#fff;}
    header{display:flex;align-items:center;gap:22px;height:70px;padding:0 3vw 0 0;background:linear-gradient(87deg,#181843 88%,#af1e36 111%);}
    .logo{height:45px;width:45px;background:#fff;object-fit:cover;border-radius:16px;margin:0 17px;}
    .title{font-size:2em;font-weight:900;color:#e50914;letter-spacing:1px;}
    .searchbox{padding:10px 19px;font-size:1.07em;border-radius:9px;border:none;outline:none;background:rgba(41,44,82,.88);color:#fff;margin-right:18px;min-width:200px;}
    .btn{padding:9px 21px;font-weight:900;font-family:'Be Vietnam Pro',sans-serif;border:none;border-radius:11px;background:#e50914;color:#fff;}
    .loginbar{margin-left:auto;display:flex;align-items:center;gap:16px;}
    .user-name{font-weight:900;font-size:1em;display:inline-block;margin-right:7px;}
    .container{max-width:1200px;margin:0 auto;padding:36px 4vw 88px 4vw;}
    .moviegrid{display:flex;flex-wrap:wrap;gap:36px;justify-content:flex-start;}
    .phimcard{flex:0 1 265px;max-width:265px;background:#22223D;border-radius:21px;box-shadow:0 6px 24px #13142b7a;overflow:hidden;display:flex;flex-direction:column;position:relative;transition:.16s;cursor:pointer;}
    .phimcard:hover{transform:scale(1.045) translateY(-8px);box-shadow:0 17px 45px #e5091456;}
    .phimimg{width:100%;aspect-ratio:2/3;object-fit:cover;display:block;}
    .badge-new{position:absolute;left:13px;top:13px;background:#e50914;color:#fff;padding:2.5px 15px;border-radius:13px;font-weight:700;}
    .badge-locked{background:#ffe066;color:#e50914;position:absolute;right:13px;top:15px;padding:2px 12.5px;border-radius:11px;font-weight:900;}
    .phimtitle{margin:15px 15px 3px 17px;font-size:1.13em;font-weight:800;}
    .phimmeta{font-size:.98em;color:#ffe066;margin:0 18px 7px;}
    .phimdesc{color:#fde9c8;margin:0 16px 8px;}
    .phimcast{color:#b6fddf;font-size:.98em;margin:0 0 7px 16px;}
    .watchbtn{margin:10px 0 17px 20px;padding:8px 21px;}
    .btn.watchbtn-ep-active{background: #ffe066 !important;color: #e50914 !important;font-weight:900;border:2px solid #ffe06644;transform:scale(1.13);}
    .modal{position:fixed;inset:0;background:rgba(16,13,29,.87);backdrop-filter:blur(9px);display:flex;align-items:center;justify-content:center;z-index:9000;}
    .modalDriveCustom{background:#221e38;border-radius:28px;box-shadow:0 10px 53px #15142569;padding:29px 22px 19px 23px;max-width:540px;width:98vw;position:relative;}
    .closebtn2{position:absolute;right:13px;top:13px;background:#e50914;color:#fff;border:none;border-radius:14px;padding:9px 16px;font-size:1.25em;}
    .movie-player-iframe{margin-bottom:14px;width:100%;}
    #playerFields{margin:19px 1px 0 7px;}
    #episodePicker{margin:10px 0;display:flex;gap:10px;flex-wrap:wrap;}
    .toast{position:fixed;right:24px;bottom:17px;z-index:39000;background:linear-gradient(90deg,#191b20 80%,#ffe066 102%);color:#e50914;padding:11px 21px 11px 13px;border-radius:9px;font-size:1.09em;box-shadow:0 2px 12px #3223;display:none;}
    .footer-moviehub{background:#1a1a24;color:#ecdcbc;text-align:center;padding:13px 3vw 13px 3vw;margin-top:44px;}
    .footer-logo{height:26px;opacity:.97;}
  </style>
</head>
<body>
<header>
  <img class="logo" src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" alt="MovieHub Logo"/>
  <span class="title">MovieHub</span>
  <div class="loginbar" id="loginBar">
    <button class="btn" onclick="location.href='dang-nhap.html'">ƒêƒÉng nh·∫≠p</button>
    <button class="btn" onclick="location.href='dang-ky.html'">ƒêƒÉng k√Ω</button>
  </div>
</header>
<div class="container">
  <h2 style="font-size:1.31em;font-weight:900;padding:0 0 18px 0;">Danh s√°ch phim MovieHub ‚Äì ƒêƒÉng nh·∫≠p ƒë·ªÉ xem t·∫≠p kho√°</h2>
  <div id="genreRows" class="moviegrid"></div>
</div>
<div id="toastMsg" class="toast" aria-live="assertive"></div>
<div id="playerModal" class="modal" style="display:none;" aria-modal="true">
  <div class="modalDriveCustom">
    <button class="closebtn2" onclick="closePlayer()" aria-label="ƒê√≥ng player phim">&times;</button>
    <div class="movie-player-iframe"><iframe id="driveFrame" allowfullscreen allow="autoplay; fullscreen" style="width:100%;min-height:230px;border-radius:17px;background:#181818;border:none;"></iframe></div>
    <div class="player-toolbar"><span id="playerTitle" style="font-weight:900"></span>
      <button class="btn" onclick="copyPlayerLink()" style="margin-left:13px;">üìã Sao ch√©p link</button></div>
    <div id="playerFields"></div>
  </div>
</div>
<footer class="footer-moviehub">
  <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" alt="MovieHub Logo" class="footer-logo"/>
  <div class="footer-content">MovieHub &copy; 2025 ‚Äì Xem phim nhi·ªÅu t·∫≠p, ti·∫øng Vi·ªát h√≥a, kh√¥ng l·ªói!</div>
</footer>
<script>
const SHEET_ID = '1G05UujE_YLzRBsIsBNmjthS3MrAzza5rdc6RQyNbmX';
const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI';
const SHEET_RANGE = 'Sheet1!A1:Z';
let phimList = [], genresSet = new Set();

function showToast(msg, dur = 2100){
  let t = document.getElementById('toastMsg');
  t.textContent = msg; t.style.display = "block";
  setTimeout(() => t.style.display = "none", dur);
}
function toggleTheme(){document.body.classList.toggle("lightmode");}
function normalizeDriveLink(lk){
  if(!lk) return "";
  return lk.replace(/\/view(\?.*)?$/,"/preview").replace(/\/edit(\?.*)?$/,"/preview").replace(/\s/g,"");
}
function getUsername(){return localStorage.getItem('moviehub_user')||"";}
function setLoginBar(){
  let user = getUsername();
  let bar = document.getElementById("loginBar");
  if(user){
    bar.innerHTML = `<span class="user-name">üë§ ${user}</span>
      <button class="btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>`;
  }else{
    bar.innerHTML = `<button class="btn" onclick="location.href='dang-nhap.html'">ƒêƒÉng nh·∫≠p</button>
      <button class="btn" onclick="location.href='dang-ky.html'">ƒêƒÉng k√Ω</button>`;
  }
}
function logout(){
  localStorage.removeItem("moviehub_user");
  setLoginBar();
  showToast("B·∫°n ƒë√£ ƒëƒÉng xu·∫•t!");
}

// CH·ªà th√™m card phim th·ª±c s·ª± h·ª£p l·ªá (t√™n, c√≥ poster, c√≥ t·∫≠p c√≥ link drive)
async function fetchPhimFromSheet(){
  let url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`;
  let res = await fetch(url); let data = await res.json();
  let rows = data.values || [], header = rows[0];
  let list = rows.slice(1).map(row=>{
    let obj={};header.forEach((h,i)=>{
      let val = (row[i]||"").trim();
      if(h.toLowerCase().includes('link google drive')) val = normalizeDriveLink(val);
      obj[h.trim()] = val;
    });return obj;
  }).filter(m=>m["T√™n phim"]||m["ID"]);
  // Gom c√°c d√≤ng c√πng ID th√†nh 1 phim
  let phimGom = {};
  list.forEach(item=>{
    let id = item["ID"]||item["T√™n phim"];
    if(!phimGom[id]) phimGom[id] = {
      id:id, title: item["T√™n phim"], desc:item["M√¥ t·∫£"], genre:item["Th·ªÉ lo·∫°i"], year:item["NƒÉm"],
      poster:item["Link poster"], special:item["Special"], cast:item["Di·ªÖn vi√™n/ƒê·∫°o di·ªÖn"], comments:item["Comments"],
      rating:item["ƒêi·ªÉm trung b√¨nh"], trailer:item["Trailer"], episodes:[]
    };
    let epNum = Number(item["T·∫≠p"]||1);
    phimGom[id].episodes.push({
      ep:epNum, title:item["M√¥ t·∫£"]||("T·∫≠p "+epNum), drive:item["Link Google Drive"], poster:item["Link poster"]||"", special:item["Special"]
    });
    genresSet.add(item["Th·ªÉ lo·∫°i"]);
  });
  // **Ch·ªâ l·∫•y phim ƒë·ªß poster, t√™n, c√≥ t·∫≠p h·ª£p l·ªá**
  phimList = Object.values(phimGom).filter(m=>{
    let poster = (m.poster && m.poster.includes("http")) || (m.episodes[0] && m.episodes[0].poster && m.episodes[0].poster.includes("http"));
    let validEp = m.episodes && m.episodes.some(ep=>ep.drive && ep.drive.startsWith("https://drive.google.com"));
    return poster && (m.title||m.id) && validEp;
  });
  renderPhim();
}

function renderPhim(){
  let html = '';
  phimList.forEach(m => {
    let isSeries = m.episodes.length>1;
    let poster = (m.poster && m.poster.includes("http")) ? m.poster
      : (m.episodes[0] && m.episodes[0].poster && m.episodes[0].poster.includes("http")) 
      ? m.episodes[0].poster : null;
    let valid = (m.title||m.id) && poster && m.episodes.some(ep=>ep.drive && ep.drive.startsWith('https://drive.google.com'));
    if(!valid) return;
    let anyLocked = m.episodes.some(ep=>String(ep.special).toLowerCase()==="yes"||String(ep.special)==="1"||String(ep.special)=="true");
    html += `<div class="phimcard" onclick="showPhim('${m.id}',1)">
      <span class="badge-new" style="${m.year >= (new Date().getFullYear()-1)?'':'display:none'}">M·ªöI</span>
      ${anyLocked?'<span class="badge-locked">Kho√°</span>':''}
      <img class="phimimg" src="${poster}" alt="Phim: ${m.title}">
      <div class="phimtitle">${m.title}</div>
      <div class="phimmeta">${m.genre||'?'}, ${m.year||''}</div>
      <div class="phimdesc">${m.desc||''}</div>
      ${m.cast?`<div class="phimcast">Di·ªÖn vi√™n/ƒê·∫°o di·ªÖn: ${m.cast}</div>`:''}
      <button class="btn watchbtn" tabindex="-1" onclick="event.stopPropagation();showPhim('${m.id}',1)">${isSeries?"Ch·ªçn t·∫≠p":"Xem phim"}</button></div>`;
  });
  document.getElementById('genreRows').innerHTML = html;
}

function copyPlayerLink(){
  navigator.clipboard.writeText(window.location.origin+window.location.pathname+window.location.hash);
  showToast("ƒê√£ sao ch√©p link phim/t·∫≠p n√†y!");
}

function showPhim(_id, ep=1) {
  let user = getUsername();
  let m = phimList.find(x => String(x.id) === String(_id));
  if (!m) return showToast("Kh√¥ng t√¨m th·∫•y phim!");
  let epList = m.episodes || [];
  let epObj = epList.find(e=>String(e.ep)==String(ep)) || epList[0] || {};
  let isLocked = String(epObj.special).toLowerCase()==="yes"||String(epObj.special)==="1"||String(epObj.special)=="true";
  if(isLocked && !user){
    showToast("T·∫≠p n√†y kho√°, b·∫°n c·∫ßn ƒëƒÉng nh·∫≠p!");
    setTimeout(()=>location.href='dang-nhap.html?return='+encodeURIComponent(window.location.hash),1200);
    return;
  }
  window.location.hash = epList.length>1 ? `id=${encodeURIComponent(m.id)}&ep=${epObj.ep||1}` : `id=${encodeURIComponent(m.id)}`;
  document.getElementById('playerTitle').innerText = epList.length>1 ? `${m.title} ‚Äì T·∫≠p ${epObj.ep}` : m.title;
  document.getElementById('playerFields').innerHTML = [
    `<div><b>M√¥ t·∫£:</b> ${m.desc||''}</div>`,
    `<div><b>NƒÉm:</b> ${m.year||''}</div>`,
    `<div><b>Th·ªÉ lo·∫°i:</b> ${m.genre||''}</div>`,
    m.cast ? `<div><b>Di·ªÖn vi√™n:</b> ${m.cast}</div>` : '',
    m.comments ? `<div><b>B√¨nh lu·∫≠n:</b> ${m.comments}</div>`:"",
    m.trailer ? `<div><b>Trailer:</b> <a href="${m.trailer}" target="_blank" style="color:#ffe066">Xem trailer</a></div>`:"",
    epList.length>1 ? `<div id="episodePicker">${
      epList.map(e=>`<button onclick="showPhim('${m.id}',${e.ep})" class="btn${e.ep==epObj.ep?' watchbtn-ep-active':''}${String(e.special).toLowerCase()==='yes'||String(e.special)=="1"||String(e.special)=="true"?' badge-locked':''}">${e.special?"üîí ":""}T·∫≠p ${e.ep}</button>`).join('')
    }</div>` : ''
  ].join('');
  let ifr = document.getElementById('driveFrame');
  if (epObj.drive && epObj.drive.includes("https://drive.google.com/")) {
    ifr.src = normalizeDriveLink(epObj.drive);
  } else {
    ifr.src = "";
    showToast("Kh√¥ng t√¨m th·∫•y link Google Drive h·ª£p l·ªá cho t·∫≠p phim n√†y!");
  }
  document.getElementById('playerModal').style.display = 'flex';
}
function closePlayer(){
  document.getElementById('driveFrame').src='';
  document.getElementById('playerModal').style.display='none';
  history.replaceState(null,null,window.location.pathname);
}

// KH·ªûI T·∫†O
window.onload = () => {
  setLoginBar();
  fetchPhimFromSheet();
  let params = new URLSearchParams(window.location.hash.replace('#',''));
  let showid = params.get('id'), epNum = +params.get('ep')||1;
  if(showid) showPhim(showid, epNum);
};
window.addEventListener("hashchange", () => {
  let params = new URLSearchParams(window.location.hash.replace('#',''));
  let showid = params.get('id'), epNum = +params.get('ep')||1;
  if(showid) showPhim(showid, epNum); else closePlayer();
});
</script>
</body>
</html>
