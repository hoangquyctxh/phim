<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>Phim Online Streaming (Google Drive) - Nâng cấp chuyên nghiệp</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { 
      background: linear-gradient(120deg, #181818 60%, #262626 100%);
      color: #fff; font-family: 'Segoe UI', Arial, sans-serif; margin:0; min-height:100vh;
      /* custom scroll */
      scrollbar-color: #e50914 #232323; 
      scrollbar-width: thin;
    }
    ::-webkit-scrollbar { width: 9px; background: #232323;}
    ::-webkit-scrollbar-thumb { background: #e50914; border-radius:7px;}
    /* Sticky header */
    header { 
      position:sticky; top:0; z-index:999; 
      background:rgba(34,34,34,0.98); padding:12px 24px; display:flex; flex-direction:row; align-items:center; gap:16px; box-shadow: 0 2px 18px #0003;
      backdrop-filter: blur(2px);
    }
    header h1 { margin:0; font-size:2.1em; color:#e50914; letter-spacing:1px;transition:.25s;}
    #search, #genres {
      flex:1; margin:0 8px; font-size:1em; border-radius:7px; border:none;
      outline:none; padding:8px 16px; background:#262626; color:#fff;
      box-shadow:0 1px 2px #0002;
    }
    #search:focus, #genres:focus { box-shadow:0 2px 10px #e5091444; }
    #movie-list {
      min-height:60vh; display:flex; flex-wrap:wrap; gap:30px; justify-content:center; 
      padding:32px 20px 50px 20px; transition:.2s;
    }
    .movie { width:210px; background:#232323; border-radius:16px; overflow:hidden; cursor:pointer;
      box-shadow:0 8px 18px #0004; transition:transform .23s, box-shadow .18s;
      position:relative; z-index:1;
    }
    .movie:hover { transform:scale(1.07); box-shadow:0 20px 40px #e5091420; border-color:#e50914;}
    .movie img { width:100%; aspect-ratio:2/3; object-fit:cover; transition:filter .2s;}
    .movie:hover img { filter:brightness(0.85);}
    .movie-info { padding:10px 16px 16px 16px;}
    .movie-title { font-size:1.17em; font-weight:bold; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis;}
    .movie-genre, .movie-year, .movie-rating { font-size:0.96em; opacity:.76;}
    .movie-rating { color:#ffe27a; font-weight:bold;}
    .movie-desc { font-size:0.96em; margin-top:7px; height:42px;overflow:hidden;text-overflow:ellipsis;}
    /* Modal bg + blur */
    #modal-player {
      position:fixed; top:0; left:0; width:100vw; height:100vh; 
      background:rgba(14,14,18,0.91); backdrop-filter: blur(8px); 
      display:none; align-items:center; justify-content:center; z-index:10000;
      animation:fadeinModal .32s;
      overflow-y:auto;
    }
    @keyframes fadeinModal {
      from { opacity:0; }
      to { opacity:1; }
    }
    #modal-content {
      background:linear-gradient(110deg,#262626 80%,#222 100%);
      border-radius:22px; padding:34px 22px; max-width:840px; width:98vw;
      box-shadow:0 12px 40px #e509141c, 0 2px 19px #222;
      animation:bounceIn .45s;
      position:relative;
    }
    @keyframes bounceIn {
      0%{ transform:scale(.7);}
      70%{ transform:scale(1.09);}
      100%{ transform:scale(1);}
    }
    #player { text-align:center;margin-bottom:20px;}
    #player iframe { box-shadow:0 0 9px #e5091465; border-radius:10px;}
    #close-btn {
      background:#e50914; color:#fff; border:none; border-radius:11px; padding:11px 16px; font-size:1em; cursor:pointer;
      float:right; font-weight:bold; transition:.17s;
      box-shadow:0 1px 6px #e5091422;
      position:absolute;right:10px;top:10px;
    }
    #close-btn:hover {background:#b0060f;}
    /* Movie details */
    #movie-detail { color:#fff;}
    #detail-poster { float:left; width:170px; border-radius:15px; margin-right:24px; box-shadow:0 3px 15px #e5091426;}
    #detail-title { font-size:1.45em; font-weight:bold; color:#ffe27a; margin-top:0;}
    #detail-genre{margin-top:2px;}
    #detail-desc { font-size:1em;}
    #rating-form { margin:14px 0;}
    #comments { margin-top:22px; max-height:160px; overflow-y:auto;}
    .comment { background:#262626; margin:8px 0; padding:10px 14px; border-radius:7px; box-shadow:0 1px 9px #2222;}
    .comment-author { font-size:.92em; font-weight:bold;}
    .comment-text { margin-top:4px;}
    #add-comment h4 {margin-top:17px;}
    /* Mobile */
    @media (max-width:700px) {
      #modal-content {padding:10px 1vw;max-width:100vw;}
      .movie{width:45vw;}
      #detail-poster{float:none;width:100%;margin:0 0 8px 0;}
      #movie-list {gap:14px;}
    }
    /* Fade out scrollbar on mobile */
    @media (max-width:550px){
      ::-webkit-scrollbar { width:0px; }
    }
  </style>
</head>
<body>
  <header>
    <h1>PHIM ONLINE</h1>
    <input type="search" id="search" placeholder="Tìm kiếm phim..."/>
    <select id="genres"><option value="">Tất cả thể loại</option></select>
  </header>
  <main id="movie-list"></main>

  <!-- Modal player + detail -->
  <div id="modal-player">
    <div id="modal-content">
      <button id="close-btn" onclick="closePlayer()">Đóng</button>
      <div id="player"></div>
      <div id="movie-detail"></div>
      <div id="rating-form"></div>
      <div id="comments"></div>
      <div id="add-comment">
        <h4>Bình luận & đánh giá</h4>
        <form onsubmit="sendComment(event)">
          <input type="text" id="comment-author" placeholder="Tên của bạn" required style="width:32%;padding:8px;"/>
          <input type="number" id="comment-rating" min="1" max="5" placeholder="Điểm (1-5)" required style="width:16%;padding:8px;"/>
          <input type="text" id="comment-text" placeholder="Bình luận..." required style="width:36%;padding:8px;"/>
          <button type="submit" style="padding:7px 14px;">Gửi</button>
        </form>
      </div>
    </div>
  </div>

  <script>
  // CONFIG
  const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ'
  const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI'
  const SHEET_RANGE = 'Sheet1!A2:H'
  const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbysq32epfb89btNoWGSxn-eEXMqeToCJQprpWkmNn_mIlyO9hfG1Kr8rHFjq47YX1eU/exec'

  let movieData = []; let genres = new Set(); let currentMovie = null; let commentsCache = {}

  async function fetchMovies() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`
    const res = await fetch(url)
    const data = await res.json()
    movieData = (data.values||[]).map(row=>({
      title:row[0]||"",desc:row[1]||"",genre:row[2]||"",drive:row[3]||"",poster:row[4]||"",year:row[5]||"",rating:parseFloat(row[6]||'0'),id:row[7]||""
    }))
    genres = new Set(movieData.map(m=>m.genre))
  }

  function filterMovies(search="", genre="") {
    search = search.trim().toLowerCase()
    return movieData.filter(m=>{
      return (!genre||m.genre===genre) &&
        (
          !search ||
          m.title.toLowerCase().includes(search) ||
          m.desc.toLowerCase().includes(search)
        )
    })
  }

  function renderGenres() {
    const sel = document.getElementById("genres")
    sel.innerHTML = '<option value="">Tất cả thể loại</option>' +
      Array.from(genres).map(g=>`<option value="${g}">${g}</option>`).join('')
  }

  function renderMovies() {
    const search = document.getElementById("search").value
    const genre = document.getElementById("genres").value
    const filtered = filterMovies(search, genre)
    document.getElementById("movie-list").innerHTML = filtered.map(m=>`
      <div class="movie" onclick="openPlayer('${m.id}')">
        <img src="${m.poster||'https://img.icons8.com/color/480/movie-projector.png'}" alt="${m.title}"/>
        <div class="movie-info">
          <div class="movie-title">${m.title}</div>
          <div class="movie-genre">${m.genre||'Khác'} | <span class="movie-year">${m.year||''}</span></div>
          ${m.rating ? `<div class="movie-rating">★ ${m.rating.toFixed(1)}/5</div>`:""}
          <div class="movie-desc">${m.desc||''}</div>
        </div>
      </div>
    `).join('')
  }

  function openPlayer(id) {
    currentMovie = movieData.find(m=>m.id===id)
    if(!currentMovie) return
    // Drive preview
    const fileId = currentMovie.drive.match(/[-\w]{25,}/)
    const embedUrl = fileId ? `https://drive.google.com/file/d/${fileId}/preview`:""
    document.body.style.overflow="hidden"
    document.getElementById("modal-player").style.display="flex"
    document.getElementById("player").innerHTML = embedUrl ?
      `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" allowfullscreen style="border-radius:10px"></iframe>`:
      '<div>Không có video</div>'
    renderDetail(currentMovie)
    renderRatingForm(currentMovie)
    loadComments(currentMovie)
  }

  function renderDetail(movie) {
    document.getElementById("movie-detail").innerHTML = `
      <img id="detail-poster" src="${movie.poster||''}" alt="${movie.title}"/>
      <h2 id="detail-title">${movie.title||''}</h2>
      <div class="movie-genre" id="detail-genre">Thể loại: <b>${movie.genre||'Không rõ'}</b></div>
      <div class="movie-year">Năm: ${movie.year||''}</div>
      <div class="movie-rating">★ ${movie.rating?movie.rating.toFixed(1):'Chưa có'}/5</div>
      <div class="movie-desc" id="detail-desc">${movie.desc||''}</div>
    `
  }

  function renderRatingForm(movie) {
    document.getElementById("rating-form").innerHTML = `
      <form onsubmit="sendRating(event)">
        <label>Chấm điểm phim: </label>
        <select id="input-rating" required>
          <option value="">Chọn...</option>
          <option value="1">1 điểm</option>
          <option value="2">2 điểm</option>
          <option value="3">3 điểm</option>
          <option value="4">4 điểm</option>
          <option value="5">5 điểm</option>
        </select>
        <button type="submit">Gửi</button>
      </form>
    `
  }

  async function sendRating(event) {
    event.preventDefault()
    const rating = document.getElementById("input-rating").value
    if (!rating || !currentMovie.id) return
    await fetch(SCRIPT_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({type:"rating",id:currentMovie.id,rating}),
      headers:{ "Content-Type":"application/json" }
    })
    alert("Chấm điểm thành công!")
    closePlayer(); await refreshData();
  }

  async function loadComments(movie) {
    const res = await fetch(`${SCRIPT_ENDPOINT}?type=comments&id=${movie.id}`)
    const data = await res.json()
    const comments = data.comments || []
    commentsCache[movie.id] = comments
    document.getElementById("comments").innerHTML = "<h4>Bình luận:</h4>" +
      (comments.length?
      comments.map(c=>`
        <div class="comment">
          <div class="comment-author">${c.author||'Ẩn danh'} ${c.rating?`★ ${c.rating}/5`:""}</div>
          <div class="comment-text">${c.text}</div>
        </div>
      `).join(''): '<i>Chưa có bình luận nào.</i>')
  }

  async function sendComment(event) {
    event.preventDefault()
    if(!currentMovie) return
    const author = document.getElementById("comment-author").value
    const text = document.getElementById("comment-text").value
    const rating = document.getElementById("comment-rating").value
    if(!author||!text||!rating) return
    await fetch(SCRIPT_ENDPOINT,{
      method:"POST",
      body: JSON.stringify({type:"comment",id:currentMovie.id,author,text,rating}),
      headers:{"Content-Type":"application/json"}
    })
    alert("Bình luận đã gửi!")
    document.getElementById("comment-author").value=""
    document.getElementById("comment-text").value=""
    document.getElementById("comment-rating").value=""
    await loadComments(currentMovie)
  }

  function closePlayer() {
    document.getElementById("modal-player").style.display = "none"
    document.getElementById("player").innerHTML=""
    document.getElementById("movie-detail").innerHTML=""
    document.getElementById("comments").innerHTML=""
    document.getElementById("rating-form").innerHTML=""
    currentMovie=null
    document.body.style.overflow=""
  }

  async function refreshData() {
    await fetchMovies()
    renderGenres()
    renderMovies()
  }

  document.getElementById("search").addEventListener("input", renderMovies)
  document.getElementById("genres").addEventListener("change", renderMovies)
  window.onload = refreshData
  </script>
</body>
</html>
