<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>Phim Online Streaming Pro (Drive/Sheet)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    html, body { margin:0; padding:0; background: radial-gradient(ellipse at top left, #181818 0%, #232323 100%); min-height:100vh;}
    body { color: #fff; font-family: 'Segoe UI', Arial, sans-serif; overflow-x:hidden;}
    /* Custom scrollbar */
    ::-webkit-scrollbar { width: 8px; background: #222;}
    ::-webkit-scrollbar-thumb { background: #e50914; border-radius:5px;}
    header {position:sticky; top:0; z-index:1000; background:rgba(30,30,30,0.98); backdrop-filter:blur(2px); padding:14px 18px; 
      display:flex; flex-direction:row; align-items:center; gap:12px; box-shadow:0 3px 18px #0002;}
    header h1 { margin:0; font-size:2em; color:#e50914; font-weight:700; letter-spacing:.5px; transition:.2s;}
    #search, #genres { padding:8px 13px; background:#232323; color:#fff; border:1px solid #292929; border-radius:7px; margin:0 4px;
      font-size:1em; box-shadow:0 2px 7px #0002;}
    #search:focus, #genres:focus {border:1px solid #e50914;}
    main {margin-bottom:40px;}
    .row-title {font-size:1.15em; color: #ffe27a; margin:17px 30px 7px 17px; font-weight:600; letter-spacing:.5px;}

    /* Movie row/slider */
    .movie-row {display:flex; flex-direction:row; overflow-x:auto; padding:7px 4vw 14px 2vw; scroll-behavior:smooth;}
    .movie-row::-webkit-scrollbar{height:5px;}
    .movie-row::-webkit-scrollbar-thumb{background:#e50914;}
    /* Carousel arrow */
    .carousel-arrow {background:#212121cc; border:none; color:#fff; font-size:1.9em; border-radius:14px; position:absolute; top:36%; width:35px; height:68px; z-index:5;
      box-shadow:0 1px 9px #1117; cursor:pointer; opacity:.38; transition:.19s;}
    .carousel-arrow:hover{background:#e50914b0; opacity:.92;}
    .carousel-arrow.left {left:3vw;}
    .carousel-arrow.right{right:3vw;}

    /* Movie card */
    .movie-card { width:170px; min-width:170px; background:#232323b8; border-radius:15px; overflow:hidden; margin:0 10px; margin-bottom:18px;
      box-shadow:0 8px 23px #0004; cursor:pointer; position:relative; transition:transform .21s, box-shadow .18s;
      display:flex; flex-direction:column;}
    .movie-card:hover { transform:scale(1.08) translateY(-7px); filter:brightness(1.05); box-shadow:0 9px 32px #e5091430;}
    .movie-card .fav-btn {position:absolute; top:7px; right:9px; background:none; border:none; font-size:1.5em; color:#ffe27a;
      cursor:pointer; opacity:.7;z-index:2;}
    .movie-card .fav-btn.fav { color:#e50914;}
    .movie-poster { width:100%; aspect-ratio:2/3; object-fit:cover; transition:filter .21s;}
    .movie-card:hover .movie-poster { filter:brightness(0.85);}
    .movie-info { padding:9px 10px 13px 11px;}
    .movie-title { font-size:1.07em;font-weight:600; margin-bottom:2px; white-space:nowrap; overflow:hidden; text-overflow: ellipsis;}
    .movie-genre, .movie-year, .movie-rating { font-size:0.93em; opacity:.8;}
    .movie-rating { color:#ffe27a; font-weight:bold;}
    .movie-badge {position:absolute; left:0;top:0;background:#e50914; color:#fff; font-size:.91em; font-weight:600; border-radius:0 11px 11px 0; padding:2px 10px;}

    /* Modal overlay */
    #modal-player {
      position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(16,16,19,0.92);backdrop-filter:blur(7px); 
      display:none; align-items:center; justify-content:center; z-index:10000; animation:fadeinModal .33s; overflow-y:auto;
    }
    @keyframes fadeinModal {from{opacity:0;} to{opacity:1;}}
    #modal-content {
      background:linear-gradient(120deg,#252522 70%,#212223 100%); border-radius:22px; padding:38px 18px 28px 18px; width:98vw; max-width:865px;
      box-shadow:0 14px 48px #e5091439,0 2px 19px #15121745; animation:bounceIn .35s; position:relative;
    }
    @keyframes bounceIn { 0%{transform:scale(.6);} 70%{transform:scale(1.11);} 100%{transform:scale(1);} }
    #player { text-align:center; margin-bottom:19px; border-radius:13px; }
    #player iframe { box-shadow:0 0 9px #e5091465; border-radius:13px;}
    #close-btn {
      background:#e50914; color:#fff; border:none; border-radius:12px; padding:11px 15px; font-size:1.06em; cursor:pointer;
      font-weight:bold; position:absolute;right:14px;top:14px; min-width:59px; transition:.17s;
      box-shadow:0 1px 7px #e5091422;z-index:10;
    }
    #close-btn:hover {background:#b0060f;}

    /* Chi ti·∫øt phim */
    #movie-detail { color:#fff; margin-bottom:13px;}
    #detail-title { font-size:1.33em; font-weight:700; color:#ffe27a; margin:0;}
    #detail-genre,#detail-year,#detail-rating{display:inline-block;margin-right:14px;}
    #detail-poster { float:left; width:152px; border-radius:14px; margin-right:20px; box-shadow:0 3px 11px #e5091426;}
    #detail-desc { font-size:1.01em; margin-top:5px;}
    #rating-form { margin:11px 0;}
    #comments { margin:12px 0 0 0; max-height:135px; overflow-y:auto;}
    .comment { background:#262626; margin:8px 0; padding:9px 12px; border-radius:7px; box-shadow:0 1px 8px #2222;}
    .comment-author { font-size:.94em; font-weight:bold;}
    .comment-text { margin-top:3px;}
    #add-comment h4 {margin-top:15px;}
    /* Suggestions - phim li√™n quan */
    #suggestion-title{font-weight:500;margin:19px 0 7px 0;font-size:1.05em;}
    .suggest-row{display:flex;gap:19px;overflow-x:auto;}
    .suggest-card{width:102px;min-width:102px;border-radius:7px;overflow:hidden;background:#2c2c2c; box-shadow:0 2px 10px #0003;cursor:pointer;transition:transform .18s;}
    .suggest-card img{width:100%;aspect-ratio:2/3;object-fit:cover;}
    .suggest-card:hover{transform:scale(1.08);}
    .suggest-card .s-title{font-size:.98em;font-weight:600;padding:3px 4px; text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    /* Watchlist, l·ªãch s·ª≠ */
    #watchlist-bar, #history-bar {margin:0 5vw 15px 3vw;}
    .fav-chip, .history-chip{
      display:inline-block; margin:0 7px 8px 0; background:#eee4; padding:4px 11px;
      border-radius:18px;font-size:1em;color:#ffe27a;font-weight:500;box-shadow:0 1px 4px #0002;
      cursor:pointer;transition:.17s;
    }
    .fav-chip:hover{background:#e5091460;color:#fff;}
    .history-chip{color:#fff;background:#18181899;}
    @media (max-width:700px){
      #modal-content {padding:8px 0;max-width:100vw;}
      .movie-card{width:37vw;min-width:105px;}
      .movie-row{padding:7px 1vw 11px 1vw;}
    }
    @media (max-width:500px){
      .movie-card{width:47vw;min-width:85px;}
    }
    /* Footer */
    footer{color:#aaa;text-align:center;padding:23px 0 11px 0;font-size:.99em;}
    a, a:visited{color:#ffe27a;}
  </style>
</head>
<body>
  <header>
    <h1>PHIM ONLINE</h1>
    <input type="search" id="search" placeholder="T√¨m ki·∫øm phim..."/>
    <select id="genres"><option value="">T·∫•t c·∫£ th·ªÉ lo·∫°i</option></select>
  </header>
  <!-- Watchlist & History -->
  <div id="watchlist-bar"></div>
  <div id="history-bar"></div>
  <main id="movie-rows"></main>
  <!-- Modal -->
  <div id="modal-player">
    <div id="modal-content">
      <button id="close-btn" onclick="closePlayer()">ƒê√≥ng</button>
      <div id="player"></div>
      <div id="movie-detail"></div>
      <div id="rating-form"></div>
      <div id="comments"></div>
      <div id="add-comment">
        <h4>B√¨nh lu·∫≠n & ƒë√°nh gi√°</h4>
        <form onsubmit="sendComment(event)">
          <input type="text" id="comment-author" placeholder="T√™n c·ªßa b·∫°n" required style="width:28%;padding:7px;"/>
          <input type="number" id="comment-rating" min="1" max="5" placeholder="ƒêi·ªÉm (1-5)" required style="width:15%;padding:7px;"/>
          <input type="text" id="comment-text" placeholder="B√¨nh lu·∫≠n..." required style="width:42%;padding:7px;"/>
          <button type="submit" style="padding:7px 14px;">G·ª≠i</button>
        </form>
      </div>
      <div id="suggestion-title"></div>
      <div class="suggest-row" id="suggest-row"></div>
    </div>
  </div>
  <footer>
    &copy; 2025 Phim Online. <a href="https://github.com/" target="_blank">Github</a> ‚Ä¢ Powered by Google Drive & Sheet API. Developed by b·∫°n!
  </footer>
  <script>
  // CONFIG
  const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ'
  const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI'
  const SHEET_RANGE = 'Sheet1!A2:H'
  const SCRIPT_ENDPOINT = 'https://script.google.com/macros/s/AKfycbysq32epfb89btNoWGSxn-eEXMqeToCJQprpWkmNn_mIlyO9hfG1Kr8rHFjq47YX1eU/exec'

  let movieData = []; let genres = new Set();
  let currentMovie = null; let commentsCache = {};
  let watchlist=[], history=[];

  // LocalStorage helpers
  function loadWatchlist(){watchlist = JSON.parse(localStorage.getItem('watchlist')||'[]');}
  function saveWatchlist(){localStorage.setItem('watchlist',JSON.stringify(watchlist));}
  function addWatch(id){ if(!watchlist.includes(id)){watchlist.unshift(id);} saveWatchlist(); renderWatchlist();}
  function removeWatch(id){watchlist=watchlist.filter(x=>x!==id); saveWatchlist();renderWatchlist();}
  function renderWatchlist(){
    if(!watchlist.length){document.getElementById('watchlist-bar').innerHTML=""; return;}
    let html='<b>üé¨ Y√™u th√≠ch: </b>';
    watchlist.forEach(id=>{
      let m=movieData.find(x=>x.id===id);
      if(m) html+=`<span class="fav-chip" onclick="openPlayer('${m.id}')">${m.title}</span>`;
    });
    html+=`<span class="fav-chip" style="background:#a03333;" onclick="clearWatchlist()">X√≥a t·∫•t c·∫£</span>`;
    document.getElementById('watchlist-bar').innerHTML=html;
  }
  function clearWatchlist(){watchlist=[];saveWatchlist();renderWatchlist();}

  // L·ªãch s·ª≠ ƒë√£ xem (local)
  function loadHistory(){history=JSON.parse(localStorage.getItem('history')||'[]');}
  function saveHistory(){localStorage.setItem('history',JSON.stringify(history));}
  function addHistory(id){ 
    history = history.filter(x=>x!==id); history.unshift(id); if(history.length>10) history.length=10;
    saveHistory(); renderHistory();
  }
  function renderHistory(){
    if(!history.length){document.getElementById('history-bar').innerHTML="";return;}
    let html='<b>üëÄ ƒê√£ xem: </b>';
    history.forEach(id=>{
      let m=movieData.find(x=>x.id===id);
      if(m) html+=`<span class="history-chip" onclick="openPlayer('${m.id}')">${m.title}</span>`;
    });
    html+=`<span class="history-chip" style="background:#2c0909;" onclick="clearHistory()">X√≥a t·∫•t c·∫£</span>`;
    document.getElementById('history-bar').innerHTML=html;
  }
  function clearHistory(){history=[];saveHistory();renderHistory();}

  async function fetchMovies() {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`
    const res = await fetch(url)
    const data = await res.json()
    movieData = (data.values||[]).map(row=>({
      title:row[0]||"",desc:row[1]||"",genre:row[2]||"",drive:row[3]||"",poster:row[4]||"",year:row[5]||"",rating:parseFloat(row[6]||'0'),id:row[7]||""
    }))
    genres = new Set(movieData.map(m=>m.genre))
  }

  // Hi·ªÉn th·ªã nhi·ªÅu row theo th·ªÉ lo·∫°i (slider)
  function renderMoviesByGenre() {
    let container = document.getElementById("movie-rows");
    container.innerHTML="";
    let gList=[...genres].filter(g=>g).sort();
    let rows = {};
    gList.forEach(g=>rows[g]=movieData.filter(m=>m.genre===g));
    // N·∫øu c√≥ t√¨m ki·∫øm th√¨ ch·ªâ show 1 row
    let search = document.getElementById("search").value.trim().toLowerCase();
    let genreSel = document.getElementById("genres").value;
    let filtered = movieData.filter(m=>{
      return (!genreSel||m.genre===genreSel) &&
        (!search || m.title.toLowerCase().includes(search)||m.desc.toLowerCase().includes(search))
    });
    if(search||genreSel){
      container.innerHTML=`
        <div class="row-title">K·∫øt qu·∫£ t√¨m ki·∫øm</div>
        <div class="movie-row">${filtered.map(m=>movieCard(m)).join('')}</div>
      `;
      return;
    }
    gList.forEach(g=>{
      if(rows[g]?.length)
      container.innerHTML+=`
        <div class="row-title">${g}</div>
        <div class="movie-row" id="row-${g.replace(/\s+/g,'_')}">${rows[g].map(m=>movieCard(m)).join('')}
          <button class="carousel-arrow left" onclick="scrollRow('${g.replace(/\s+/g,'_')}',-1)">&#8592;</button>
          <button class="carousel-arrow right" onclick="scrollRow('${g.replace(/\s+/g,'_')}',1)">&#8594;</button>
        </div>
      `;
    });
  }

  function movieCard(m){
    let isWatch=watchlist.includes(m.id);
    let isHist=history.includes(m.id);
    return `
      <div class="movie-card" onclick="openPlayer('${m.id}')">
        <button class="fav-btn${isWatch?' fav':''}" title="Y√™u th√≠ch/phim hot" onclick="event.stopPropagation();toggleWatch('${m.id}')">${isWatch?'‚òÖ':'‚òÜ'}</button>
        ${isHist?'<div class="movie-badge">ƒê√£ xem</div>':""}
        <img class="movie-poster" src="${m.poster||'https://img.icons8.com/color/480/movie-projector.png'}" alt="${m.title}"/>
        <div class="movie-info">
          <div class="movie-title">${m.title}</div>
          <div class="movie-genre">${m.genre||'Kh√°c'} | <span class="movie-year">${m.year||''}</span></div>
          ${m.rating ? `<div class="movie-rating">‚òÖ ${m.rating.toFixed(1)}/5</div>`:""}
          <div class="movie-desc">${m.desc||''}</div>
        </div>
      </div>
    `;
  }
  window.toggleWatch = function(id){
    if(watchlist.includes(id)) removeWatch(id);
    else addWatch(id);
    renderMoviesByGenre();
  }
  window.scrollRow = function(rowId, dir){
    let e=document.getElementById('row-'+rowId);
    if(e){e.scrollBy({left:dir*320,behavior:'smooth'});}
  }

  function openPlayer(id) {
    currentMovie = movieData.find(m=>m.id===id)
    if(!currentMovie) return
    addHistory(currentMovie.id);
    document.body.style.overflow="hidden"
    document.getElementById("modal-player").style.display="flex"
    // Drive preview
    const fileId = currentMovie.drive.match(/[-\w]{25,}/)
    const embedUrl = fileId ? `https://drive.google.com/file/d/${fileId}/preview`:""
    document.getElementById("player").innerHTML = embedUrl ?
      `<iframe src="${embedUrl}" width="800" height="450" allow="autoplay" allowfullscreen style="border-radius:11px"></iframe>`:
      '<div>Kh√¥ng c√≥ video</div>'
    renderDetail(currentMovie);
    renderRatingForm(currentMovie);
    loadComments(currentMovie);
    renderSuggestion(currentMovie);
  }

  function renderDetail(movie) {
    document.getElementById("movie-detail").innerHTML = `
      <img id="detail-poster" src="${movie.poster||''}" alt="${movie.title}"/>
      <h2 id="detail-title">${movie.title||''}</h2>
      <div id="detail-genre">Th·ªÉ lo·∫°i: <b>${movie.genre||'Kh√¥ng r√µ'}</b></div>
      <div id="detail-year">NƒÉm: ${movie.year||''}</div>
      <div id="detail-rating">‚òÖ ${movie.rating?movie.rating.toFixed(1):'Ch∆∞a c√≥'}/5</div>
      <div id="detail-desc">${movie.desc||''}</div>
    `
  }

  function renderRatingForm(movie) {
    document.getElement
