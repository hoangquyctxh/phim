<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8"/>
  <title>MovieHub - Đăng nhập, xem phim theo quyền</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {margin:0;background:#181818;color:#fff;font-family:'Segoe UI',Arial,sans-serif;}
    header {display:flex;align-items:center;gap:13px;padding:12px 8vw 14px 4vw;background:#212121;border-bottom:2px solid #222;}
    .logo {height:38px;}
    .title {font-size:2em;color:#e50914;font-weight:bold;margin-left:3px;}
    .right {margin-left:auto;}
    .btn {padding:8px 17px;border:none;border-radius:7px;background:#e50914;color:#fff;font-weight:600;cursor:pointer;}
    .btn:hover {background:#aa0814;}
    .logout, .loginhdr {background:transparent;color:#ffe066;border:none;margin-left:20px;font-size:1em;}
    .logout:hover, .loginhdr:hover {color:#e50914;}
    .container {max-width:1040px;margin:0 auto;padding:28px 7vw 90px 7vw;}
    h2 {margin-top:40px;text-shadow:0 2px 6px #0009;}
    .phimlist {display:flex;flex-wrap:wrap;gap:32px;}
    .phimcard {flex:0 0 210px;background:#222;border-radius:17px;padding:0 0 13px 0;box-shadow:0 3px 30px #1118;overflow:hidden;position:relative;margin-bottom:14px;}
    .phimimg {width:100%;aspect-ratio:2/3;object-fit:cover;border-bottom:2px solid #262626;}
    .phimtitle{font-size:1.08em;margin:11px 15px 6px 15px;font-weight:700;}
    .phimmeta{font-size:.99em;color:#ffe099;padding:0 15px;}
    .badge-new{display:inline-block;background:#e50914;color:#fff;padding:2px 13px 2px 13px;font-size:.96em;border-radius:7px;margin:8px 0 0 13px;}
    .badge-locked{background:#bbb;color:#222;padding:2px 12px;border-radius:9px;font-size:.97em;position:absolute;top:11px;right:13px;}
    .watchbtn{margin:15px 0 0 15px;padding:7px 21px;font-size:1.01em;}
    .watchbtn.locked{background:#666;color:#ccc;}
    .modal{position:fixed;inset:0;background:#101826cc;backdrop-filter:blur(2px);display:flex;align-items:center;justify-content:center;z-index:9999;}
    .modalInner{background:#232323;padding:27px 21px 21px 21px;border-radius:16px;width:320px;max-width:99vw;box-shadow:0 8px 32px #000b;}
    .modal h3{margin-top:0;}
    .modal label{display:block;margin:11px 0 5px 0;}
    .modal input[type='text'],.modal input[type='password']{padding:9px;font-size:1em;width:90%;border-radius:7px;border:none;margin-bottom:9px;}
    .modal input:focus{outline:2px solid #e50914;}
    .modal .btn{width:100%;margin-top:12px;}
    .modal .errmsg{color:#e50914;margin:9px 0 0 0;}
    .closebtn{background:transparent;color:#e50914;border:none;font-size:1.65em;position:absolute;top:13px;right:19px;font-weight:900;cursor:pointer;}
    .player-modal-inner{max-width:99vw;padding:13px 11px 9px 11px;}
    .player {width:100%;aspect-ratio:15/9;max-width:650px;min-width:240px;border-radius:9px;background:#111;margin-bottom:15px;}
    @media (max-width:730px){
      .container{padding:12px 2vw 60px 2vw;}
      .phimlist{gap:12vw;}
      .phimcard{flex-basis:47vw;max-width:97vw;}
    }
  </style>
</head>
<body>
<header>
  <img src="https://user-gen-media-assets.s3.amazonaws.com/seedream_images/a75fa0ae-d935-45d3-a56a-67182b3177fa.png" class="logo" alt="MovieHub"/>
  <span class="title">MovieHub</span>
  <div class="right">
    <button id="loginBtn" class="loginhdr btn" onclick="showLogin()" style="display:inline-block">Đăng nhập</button>
    <button id="logoutBtn" class="logout" onclick="logoutApp()" style="display:none">Đăng xuất</button>
  </div>
</header>
<div class="container">
  <h2>Kho phim online - Xem phim theo đặc quyền tài khoản</h2>
  <div id="phimlist" class="phimlist"></div>
</div>
<div id="loginModal" class="modal" style="display:none;">
  <div class="modalInner">
    <button class="closebtn" onclick="closeLogin()">&times;</button>
    <h3>Đăng nhập MovieHub</h3>
    <label>Tài khoản:</label>
    <input type="text" id="loginUser" autocomplete="username">
    <label>Mật khẩu:</label>
    <input type="password" id="loginPass" autocomplete="current-password">
    <div class="errmsg" id="loginErr" style="display:none"></div>
    <button class="btn" onclick="doLogin()">Đăng nhập</button>
  </div>
</div>
<div id="playerModal" class="modal" style="display:none;">
  <div class="modalInner player-modal-inner">
    <button class="closebtn" onclick="closePlayer()">&times;</button>
    <div id="player"></div>
    <div id="playerTitle" style="margin-top:7px;font-size:1.1em;font-weight:700"></div>
  </div>
</div>
<script>
const SHEET_ID = '15mFrve7Z-_zi_7AvSq3t9Nti1VjINVHCQDF7LRmP1QQ';
const API_KEY = 'AIzaSyD5dWLgYZPu1_-AkwAaHPClGOOQ-Lq5EGI';
const SHEET_RANGE = 'Sheet1!A1:Z';
const USERS_RANGE = 'Users!A2:C';
let userList = [];
let phimList = [];
let loggedUser = false, userName = '';

async function fetchUsers() {
  const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${USERS_RANGE}?key=${API_KEY}`;
  let res = await fetch(url); let data = await res.json();
  userList = (data.values||[]).map(r=>({user:r[0]?.trim(),pass:r[1]?.trim(),role:r[2]?.trim()}));
}
async function fetchPhim() {
  let url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${SHEET_RANGE}?key=${API_KEY}`;
  let res = await fetch(url); let data = await res.json();
  let rows = data.values||[], header = rows[0];
  let idx = n => header.findIndex(x=>x&&x.trim().toLowerCase() === n);
  phimList = rows.slice(1).map(row=>({
    title:row[idx('tên phim')]||'',
    desc:row[idx('mô tả')]||'',
    genre:row[idx('thể loại')]||'',
    drive:row[idx('link google drive')]||'',
    poster:row[idx('link poster')]||'',
    year:row[idx('năm')]||'',
    id:row[idx('id')]||row[idx('tên phim')]||'',
    special: (row[idx('special')]||'').trim().toLowerCase()==='yes',
    isNew: row[idx('năm')] && +row[idx('năm')] >= (new Date().getFullYear()-1)
  })).filter(m=>m.title);
}

function renderPhim() {
  let html = phimList.map(m=>`<div class="phimcard">
    ${m.isNew?'<span class="badge-new">MỚI</span>':''}
    ${m.special?'<span class="badge-locked">Khoá</span>':''}
    <img class="phimimg" src="${m.poster||'https://img.icons8.com/color/480/movie-projector.png'}" alt="">
    <div class="phimtitle">${m.title}</div>
    <div class="phimmeta">${m.genre||'Chưa rõ'} | ${m.year||''}</div>
    <button class="btn watchbtn${m.special&&!loggedUser?' locked':''}"
      onclick="${m.special&&!loggedUser?'showLogin()':`showPhim('${encodeURIComponent(m.id)}')`}">
      ${m.special&&!loggedUser?'Chỉ thành viên':'Xem phim'}
    </button>
  </div>`).join('');
  document.getElementById('phimlist').innerHTML = html;
  document.getElementById('logoutBtn').style.display = loggedUser ? 'inline-block' : 'none';
  document.getElementById('loginBtn').style.display = loggedUser ? 'none' : 'inline-block';
}

function showPhim(_id){
  let phim = phimList.find(m=>encodeURIComponent(m.id)===_id);
  if(!phim) return alert("Không tìm thấy phim");
  if(phim.special&&!loggedUser) { showLogin(); return; }
  document.getElementById('player').innerHTML = phim.drive.match(/[-\w]{25,}/)
    ? `<iframe src="https://drive.google.com/file/d/${phim.drive.match(/[-\w]{25,}/)}/preview" allowfullscreen style="width:100%;aspect-ratio:16/9;min-height:200px;border:none;"></iframe>`
    : '<div style="color:#fff;text-align:center">Không có video</div>';
  document.getElementById('playerTitle').innerText = phim.title;
  document.getElementById('playerModal').style.display = 'flex';
}
function closePlayer(){
  document.getElementById('player').innerHTML='';
  document.getElementById('playerModal').style.display='none';
}
function showLogin(){
  document.getElementById('loginModal').style.display = 'flex';
  document.getElementById('loginUser').value = '';
  document.getElementById('loginPass').value = '';
  document.getElementById('loginErr').style.display = 'none';
  setTimeout(()=>document.getElementById('loginUser').focus(),100);
}
function closeLogin(){
  document.getElementById('loginModal').style.display='none';
}
function doLogin() {
  let user = document.getElementById('loginUser').value.trim();
  let pass = document.getElementById('loginPass').value.trim();
  let found = userList.find(u=>u.user===user&&u.pass===pass);
  if(found){
    loggedUser = true;
    userName = found.user;
    closeLogin();
    renderPhim();
    alert('Đăng nhập thành công!');
  } else {
    document.getElementById('loginErr').innerText = 'Sai tài khoản hoặc mật khẩu!';
    document.getElementById('loginErr').style.display = 'block';
  }
}
function logoutApp(){
  loggedUser = false; userName = '';
  renderPhim();
  alert('Đã đăng xuất!');
}
window.onload = async ()=>{
  await fetchUsers();
  await fetchPhim();
  renderPhim();
}
</script>
</body>
</html>
